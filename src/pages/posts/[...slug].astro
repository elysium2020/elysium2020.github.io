---
import { allPosts } from '@/lib/content';
import { formatDate } from '@/lib/utils';
import Layout from '@/layouts/Layout.astro';
import { Badge } from '@/components/ui/badge';
import { Tag, Calendar, ArrowLeft, House, ArrowRight } from 'lucide-react';

export async function getStaticPaths() {
  return allPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const idx = allPosts.findIndex((p) => p.slug === post.slug);
const prev = idx > 0 ? allPosts[idx - 1] : undefined;
const next = idx + 1 < allPosts.length ? allPosts[idx + 1] : undefined;
---

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"
  crossorigin="anonymous"
  media="print"
  onload="this.media='all';"
/>

<Layout pageTitle={post.data.title}>
  <main class="mx-auto max-w-6xl p-6 lg:p-8">
    <div class="gap-8">
      <article
        class="prose prose-zinc dark:prose-invert prose-lg lg:prose-xl prose-img:my-6 prose-pre:my-6 prose-blockquote:my-6 prose-headings:font-semibold max-w-none"
        role="article"
        aria-label={post.data.title}>
        <header class="mb-6 text-center">
          <h1
            class="mb-4 scroll-m-20 text-4xl font-extrabold tracking-tight lg:text-5xl">
            {post.data.title}
          </h1>

          <div
            class="text-muted-foreground flex flex-wrap items-center gap-3 text-sm">
            <Badge
              variant="secondary"
              className="inline-flex items-center gap-2">
              <Calendar aria-hidden="true" className="h-4 w-4" />
              <time>{formatDate(post.data.pubDate)}</time>
            </Badge>
          </div>
        </header>

        <div id="post-content" class="mt-6">
          <Content />
        </div>

        <footer class="mt-12 border-t pt-8">
          <div class="mb-6 flex flex-wrap items-center gap-3">
            {
              post.data.tags?.map((tag: string) => (
                <a href={`/tags/${tag}`} class="inline-block">
                  <Badge
                    variant="outline"
                    className="inline-flex items-center gap-1 transition-colors duration-200 hover:bg-primary/10 hover:text-primary">
                    <Tag aria-hidden="true" className="h-3.5 w-3.5" />
                    <span>{tag}</span>
                  </Badge>
                </a>
              ))
            }
          </div>

          <nav class="flex flex-col gap-3 sm:flex-row sm:justify-between">
            <div>
              {
                prev ?
                  <a
                    href={`/posts/${prev.slug}`}
                    class="inline-flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-transform duration-150 hover:translate-x-1">
                    <span class="flex">
                      <ArrowLeft />
                      {prev.data.title}
                    </span>
                  </a>
                : <span class="text-muted-foreground text-sm">没有上一篇</span>
              }
            </div>

            <div
              class="inline-flex items-center rounded-md px-3 py-2 text-center text-sm font-medium transition-transform duration-150 hover:-translate-y-1"
              ><span class="flex gap-3"
                ><House /><a href="/posts">返回文章列表</a></span
              >
            </div>

            <div class="text-right">
              {
                next ?
                  <a
                    href={`/posts/${next.slug}`}
                    class="inline-flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-transform duration-150 hover:-translate-x-1">
                    <span class="flex">
                      {next.data.title}
                      <ArrowRight />
                    </span>
                  </a>
                : <span class="text-muted-foreground text-sm">没有下一篇</span>
              }
            </div>
          </nav>
        </footer>
      </article>
    </div>
  </main>
</Layout>

<style>
  .prose p {
    text-indent: 2em;
  }
</style>
