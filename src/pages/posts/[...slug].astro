---
import { allPosts, sortedPosts } from '@/lib/content';
import { formatDate } from '@/lib/utils';
import Layout from '@/layouts/Layout.astro';
import { Badge } from '@/components/ui/badge';
import { Tag, Calendar, ArrowLeft, House, ArrowRight } from 'lucide-react';

export async function getStaticPaths() {
  return allPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const idx = sortedPosts.findIndex((p) => p.slug === post.slug);
const next = idx > 0 ? sortedPosts[idx - 1] : undefined;
const prev = idx + 1 < sortedPosts.length ? sortedPosts[idx + 1] : undefined;
---

<Layout pageTitle={post.data.title} description={post.data.description}>
  <link
    slot="head"
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"
    crossorigin="anonymous"
    media="print"
    onload="this.media='all';"
  />

  <main class="mx-auto max-w-6xl p-6 lg:p-8">
    <article
      class="prose prose-zinc dark:prose-invert prose-lg lg:prose-xl prose-img:my-6 prose-pre:my-6 prose-blockquote:my-6 prose-headings:font-semibold max-w-none"
      role="article"
      aria-label={post.data.title}>
      <header class="mb-6 text-center">
        <h1
          class="mb-4 scroll-m-20 text-4xl font-extrabold tracking-tight lg:text-5xl">
          {post.data.title}
        </h1>

        <div class="text-muted-foreground text-sm">
          <Badge variant="secondary" className="gap-2">
            <Calendar aria-hidden="true" className="h-4 w-4" />
            <time>{formatDate(post.data.pubDate)}</time>
          </Badge>
        </div>
      </header>

      <div id="post-content" class="mt-6">
        <Content />
      </div>

      <footer class="not-prose mt-12 border-t pt-8">
        <div class="mb-6 flex flex-wrap items-center gap-3">
          {
            post.data.tags?.map((tag: string) => (
              <a href={`/tags/${tag}`} class="inline-block">
                <Badge
                  variant="outline"
                  className="transition-colors duration-200 hover:bg-primary/10 hover:text-primary">
                  <Tag aria-hidden="true" className="h-3.5 w-3.5" />
                  <span>{tag}</span>
                </Badge>
              </a>
            ))
          }
        </div>

        <nav class="flex w-full items-center text-sm">
          <div class="flex min-w-0 flex-1 justify-start">
            {
              prev ?
                <a
                  href={`/posts/${prev.slug}`}
                  class="text-muted-foreground hover:text-primary inline-flex items-center gap-2 font-medium transition-colors duration-200">
                  <ArrowLeft className="h-4 w-4 shrink-0" />
                  <span class="max-w-[16rem] truncate">{prev.data.title}</span>
                </a>
              : <span class="text-muted-foreground/50 italic">没有上一篇</span>
            }
          </div>

          <div class="flex shrink-0 justify-center px-4">
            <a
              href="/posts"
              class="text-muted-foreground hover:text-primary inline-flex items-center gap-2 font-medium transition-colors duration-200">
              <House className="h-4 w-4 shrink-0" />
              <span>返回文章列表</span>
            </a>
          </div>

          <div class="flex min-w-0 flex-1 justify-end">
            {
              next ?
                <a
                  href={`/posts/${next.slug}`}
                  class="text-muted-foreground hover:text-primary inline-flex items-center gap-2 font-medium transition-colors duration-200">
                  <span class="max-w-[16rem] truncate text-right">
                    {next.data.title}
                  </span>
                  <ArrowRight className="h-4 w-4 shrink-0" />
                </a>
              : <span class="text-muted-foreground/50 italic">没有下一篇</span>
            }
          </div>
        </nav>
      </footer>
    </article>
  </main>
</Layout>
